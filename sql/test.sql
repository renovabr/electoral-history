--
-- Tests (https://www.eversql.com/sql-syntax-check-validator/))
--

-- (0-1)
DROP TABLE IF EXISTS raw_tse_consult_candidates;

ALTER TABLE raw_tse_consult_candidates PARTITION BY RANGE (UNIX_TIMESTAMP(end_partition)) (
    PARTITION p2010 VALUES LESS THAN (UNIX_TIMESTAMP('2010-12-31 23:59:59')),
    PARTITION p2012 VALUES LESS THAN (UNIX_TIMESTAMP('2012-12-31 23:59:59')),
    PARTITION p2014 VALUES LESS THAN (UNIX_TIMESTAMP('2014-12-31 23:59:59')),
    PARTITION p2016 VALUES LESS THAN (UNIX_TIMESTAMP('2016-12-31 23:59:59')),
    PARTITION p2018 VALUES LESS THAN (UNIX_TIMESTAMP('2018-12-31 23:59:59')),
    PARTITION p2020 VALUES LESS THAN (UNIX_TIMESTAMP('2020-12-31 23:59:59')),    
    PARTITION pmax VALUES LESS THAN (MAXVALUE)
);

SELECT COUNT(*) FROM raw_tse_consult_candidates PARTITION (p2010);
SELECT * FROM raw_tse_consult_candidates LIMIT 10;

-- (0-2)
DROP TABLE IF EXISTS raw_tse_voting_cand_city;

ALTER TABLE raw_tse_voting_cand_city PARTITION BY RANGE (UNIX_TIMESTAMP(end_partition)) (
    PARTITION p2010 VALUES LESS THAN (UNIX_TIMESTAMP('2010-12-31 23:59:59')),
    PARTITION p2012 VALUES LESS THAN (UNIX_TIMESTAMP('2012-12-31 23:59:59')),
    PARTITION p2014 VALUES LESS THAN (UNIX_TIMESTAMP('2014-12-31 23:59:59')),
    PARTITION p2016 VALUES LESS THAN (UNIX_TIMESTAMP('2016-12-31 23:59:59')),
    PARTITION p2018 VALUES LESS THAN (UNIX_TIMESTAMP('2018-12-31 23:59:59')),
    PARTITION p2020 VALUES LESS THAN (UNIX_TIMESTAMP('2020-12-31 23:59:59')),    
    PARTITION pmax VALUES LESS THAN (MAXVALUE)
);

SELECT COUNT(*) FROM raw_tse_voting_cand_city PARTITION (p2014);
SELECT * FROM raw_tse_voting_cand_city LIMIT 10;

-- (0-3)
DROP TABLE IF EXISTS raw_tse_voting_party_city;

ALTER TABLE raw_tse_voting_party_city PARTITION BY RANGE (UNIX_TIMESTAMP(end_partition)) (
    PARTITION p2010 VALUES LESS THAN (UNIX_TIMESTAMP('2010-12-31 23:59:59')),
    PARTITION p2012 VALUES LESS THAN (UNIX_TIMESTAMP('2012-12-31 23:59:59')),
    PARTITION p2014 VALUES LESS THAN (UNIX_TIMESTAMP('2014-12-31 23:59:59')),
    PARTITION p2016 VALUES LESS THAN (UNIX_TIMESTAMP('2016-12-31 23:59:59')),
    PARTITION p2018 VALUES LESS THAN (UNIX_TIMESTAMP('2018-12-31 23:59:59')),
    PARTITION p2020 VALUES LESS THAN (UNIX_TIMESTAMP('2020-12-31 23:59:59')),    
    PARTITION pmax VALUES LESS THAN (MAXVALUE)
);

SELECT COUNT(*) FROM raw_tse_voting_party_city PARTITION (p2014);
SELECT * FROM raw_tse_voting_party_city LIMIT 10;

-- (0-4)
SELECT
  sq_candidate AS SQ,
  nm_ballot_candidate AS Name,
  ds_position AS Position,
  nm_city AS City,
  format(sum(qt_votes_nominal), 0, 'de_DE') AS Votes 
FROM
  raw_tse_voting_cand_city 
WHERE
  election_year = '2018' 
  AND sg_uf = 'SP' 
  AND nr_shift = 1 
  AND cd_position = 3 
GROUP BY
  1,
  2,
  3,
  4 
ORDER BY
  sum(qt_votes_nominal) DESC;